<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function() {
	/* widget controller */
	var c = this;

	c.showOverview = true;

	c.showOverviewDiv = function() {
		c.showOverview = true;
		c.showAppList = false;
		c.showServices = false;
	};

	c.showApplicationList = function () {
		c.showOverview = false;
		c.showAppList = true;
	};

	c.hideApplicationList = function () {
		c.showOverview = true;
		c.showAppList = false;
	};

	c.showServiceList = function () {
		c.showOverview = false;
		c.showServices = true;
	};

	c.hideServiceList = function () {
		c.showOverview = true;
		c.showServices = false;
	};

	
	function chunk(arr, size) {
		var newArr = [];
		for (var i=0; i<arr.length; i+=size) {
			newArr.push(arr.slice(i, i+size));
		}
		return newArr;
	}
	
	if(c.options.app_chunk_size != 0 && c.options.app_chunk_size != null) {
		c.chunkedAppData = chunk(c.data.appList, c.options.app_chunk_size);
		c.appsChunked = true;
	}

	if(c.options.service_chunk_size != 0 && c.options.service_chunk_size != null) {
		c.chunkedServiceData = chunk(c.data.serviceList, c.options.service_chunk_size);
		c.servicesChunked = true;
	}
	
}]]></client_script>
        <controller_as>c</controller_as>
        <css>@font-face {
  font-family: 'Gotham';
  src: url('/sys_attachment.do?sys_id=9d1a187c1314b20022c6bcc32244b0dc');
}

@font-face {
  font-family: 'Gotham-Book';
  src: url('/sys_attachment.do?sys_id=1c512cfc1314b20022c6bcc32244b0f5');
}

.gap-right {
  margin-right: 10px; 
}

.bg {
  width: 375px;
  height: 57px;
  object-fit: contain;
  background-image: url("architecture-bg.png");
  padding-left: 18px;
}

.overview {
  width: 375px;
  height: 667px;
  background-color: #ffffff;
}

.rectangle {
  width: 275px;
  height: 125px;
  border-radius: 5px;
  border: solid 1px #696e7a;
  margin-left: 50px;
  margin-right: 50px;
  margin-top: 30px;
  cursor: pointer;
}

.rectangles {
  padding-bottom: 50px;
}

.rectangle-dev {
  cursor: auto;
  height: 150px;
}

.layer {
  width: 275px;
  height: 60px;
  font-family: 'Source Sans Pro', sans-serif;

  font-size: 48px;
  font-weight: 300;
  font-style: normal;
  font-stretch: normal;
  text-align: center;
  color: #ff6f00;
}

.total {
  width: 275px;
  height: 40px;
  font-family: 'Source Sans Pro', sans-serif;
  font-size: 32px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  text-align: center;
  color: #485563;
}

.icon-lock {
  padding-right: 10px;
  height: 43px;
}

.resolve {
  width: 100%
    height: 12px;
  opacity: 0.6;
  font-family: Gotham;
  font-size: 12px;
  //font-weight: bold;
  font-style: normal;
  font-stretch: normal;
  text-align: center;
  color: #ffffff;
  display: inline-block;
  vertical-align: middle;
  padding-top: 7px;
  cursor: pointer;
}

.app-build {
  height: 16px;
  font-family: Gotham;
  font-size: 16px;
  font-weight: 500;
  font-style: normal;
  font-stretch: normal;
  text-align: left;
  padding-left: 10px;
  color: #696e7a;
}

.app-desc {
  width: 135px;
  height: 28px;
  font-family: Gotham-Book;
  font-size: 14px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  color: #696e7a;
}

.applications-breadcrumb {
  width: 74px;
  height: 12px;
  font-family: Gotham;
  font-size: 12px;
  font-weight: 300;
  font-style: normal;
  font-stretch: normal;
  text-align: center;
  color: #696e7a;
}

.appname-breadcrumb {
  width: 48px;
  height: 12px;
  font-family: Gotham;
  font-size: 12px;
  font-weight: bold;
  font-style: normal;
  font-stretch: normal;
  text-align: center;
  color: #696e7a;
}

.app-name {
  font-family: Gotham-Book;
  font-size: 14px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  color: #696e7a;
  margin-top: 30px;
}

.app-block { 
  //display: inline-block;
  vertical-align: middle;
}

.app-block-img {
  width: 24px;
  height: 24px;
  display: inline-block;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>reference-architecture-dashboard</id>
        <internal>false</internal>
        <link/>
        <name>Reference Architecture - Dashboard</name>
        <option_schema>[{"name":"app_chunk_size","label":"App Chunk Size","type":"integer"},{"name":"service_chunk_size","label":"Service Chunk Size","type":"integer"},{"displayValue":"Experience","name":"experience","label":"Experience","type":"reference","value":"x_snc_proto_refarc_experience","ed":{"reference":"x_snc_proto_refarc_experience"}}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */

	if(!input) {

		getExperienceData();
		data.applicationCount = getApplicationCount(options.experience);
		data.serviceCount = getServiceCount(options.experience);
		data.appList = getAppDetails(options.experience);
		data.serviceList = getServiceDetails(options.experience);
	}

	function getExperienceData() {
		var grExp = new GlideRecord("x_snc_proto_refarc_experience");
		if(grExp.get(options.experience)) {
			data.banner_img = grExp.getDisplayValue("banner_image") || "fallback-icon.png";
			data.experience_name = grExp.getDisplayValue("experience_name");
			data.experience_short_handle = grExp.getDisplayValue("experience_short_handle");
			data.devEffort = getDevHours(options.experience);
		}
	}


	function getApplicationCount(experienceId) {
		var grApp = new GlideRecord("x_snc_proto_refarc_m2m_applications_experiences");
		grApp.addQuery("experience", experienceId);
		grApp.query();
		return grApp.getRowCount();
	}


	function getAppDetails(experienceId) {
		var apps = [];


		var grAppForExp = new GlideRecord("x_snc_proto_refarc_m2m_applications_experiences");
		grAppForExp.addQuery("experience", experienceId);
		grAppForExp.query();
		while(grAppForExp.next()) {
			var grApp = new GlideRecord("x_snc_proto_refarc_application");
			grApp.query("sys_id", grAppForExp.getValue("application"));
			grApp.query();
			if(grApp.next()) {
				apps.push({
					"name":grApp.getDisplayValue(),
					"image": grApp.getDisplayValue("image"),
					"link": grApp.getDisplayValue("link")
				});
			}
		}

		return apps;
	}


	function getServiceCount(experienceId) {
		var grService = new GlideRecord("x_snc_proto_refarc_m2m_services_experiences");
		grService.addQuery("experience", experienceId);
		grService.query();
		return grService.getRowCount();


	}

	function getServiceDetails(experienceId) {
		var services = [];

		var grServiceForExp = new GlideRecord("x_snc_proto_refarc_m2m_services_experiences");
		grServiceForExp.addQuery("experience", experienceId);
		grServiceForExp.query();
		while(grServiceForExp.next()) {
			var grService = new GlideRecord("x_snc_proto_refarc_service");
			grService.query("sys_id", grServiceForExp.getValue("service"));
			grService.orderBy("name");
			grService.query();
			while(grService.next()) {
				services.push({
					"name":grService.getDisplayValue(),
					"image": grService.getDisplayValue("image"),
					"link": grService.getDisplayValue("link")
				});
			}

		}


		return services;
	}
	

	function getDevHours(experienceId) {
		var totalHours = 0.0;
		
		var grHours = new GlideRecord("time_card");
		grHours.addQuery("x_snc_proto_refarc_experience", experienceId);
		grHours.query();
		while(grHours.next()) {			
			totalHours = totalHours + parseFloat(grHours.getValue("total"));
		}

		return totalHours;
	}
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>frank.schuster</sys_created_by>
        <sys_created_on>2017-01-10 00:35:41</sys_created_on>
        <sys_customer_update>true</sys_customer_update>
        <sys_id>d66bfe9813dc720022c6bcc32244b01e</sys_id>
        <sys_mod_count>201</sys_mod_count>
        <sys_name>Reference Architecture - Dashboard</sys_name>
        <sys_package display_value="Prototype Reference Architecture" source="x_snc_proto_refarc">e24a43e6dbcc3a00eb8278b5ae961961</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Prototype Reference Architecture">e24a43e6dbcc3a00eb8278b5ae961961</sys_scope>
        <sys_update_name>sp_widget_d66bfe9813dc720022c6bcc32244b01e</sys_update_name>
        <sys_updated_by>frank.schuster</sys_updated_by>
        <sys_updated_on>2017-01-16 20:17:54</sys_updated_on>
        <template><![CDATA[<style>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400" rel="stylesheet">
</style>

<div class="overview" >
  <div class="bg">
    <div class="resolve" ng-click="c.showOverviewDiv()">
      <img class="icon-lock" src="{{c.data.banner_img}}">
      {{c.data.experience_name}}
    </div>
  </div>
  

  <div class="rectangles" ng-show="c.showOverview">
    <div>
      <ol class="breadcrumb">
        <li><a href="javascript:void(0)" class="appname-breadcrumb">{{c.data.experience_short_handle}} Home</a></li>
      </ol>
    </div>
    <div class="rectangle" ng-click="c.showApplicationList()">
      <div class="layer" >
        <p>{{c.data.applicationCount}}</p>
      </div>

      <div class="total">
        <p>Applications</p>
      </div>      
    </div>
    <div class="rectangle" ng-click="c.showServiceList()">
      <div class="layer">
        <p>{{c.data.serviceCount}}</p>
      </div>

      <div class="total">
        <p>Services</p>
      </div>
    </div>
    <div class="rectangle rectangle-dev">
      <div class="layer">
        <p>{{c.data.devEffort}}h</p>
      </div>

      <div class="total">
        <p>Development <br/> Effort</p>
      </div>
    </div>
  </div>

  <div class="applist" ng-show="c.showAppList">
    <div>
      <ol class="breadcrumb">
        <li><a href="javascript:void(0)" class="appname-breadcrumb" ng-click="c.hideApplicationList()">{{c.data.experience_short_handle}}</a></li>
        <li class="applications-breadcrumb">Applications</li>
      </ol>
    </div>
    <div class="app-build">
      <span> We built this app using... </span>
    </div>

    <div class="col-xs-6 app-name" ng-repeat="apps in c.chunkedAppData" ng-if="c.appsChunked">
      <div class="app-block" ng-repeat="app in apps">
        <img src="{{app.image}}" class="app-block-img pull-left gap-right">
        <p ng-if="app.link"><a href="{{app.link}}" target="_blank">{{app.name}}</a></p>
        <p ng-if="!app.link">{{app.name}}</p>
      </div>
    </div>

    <div class="col-xs-12 app-name" ng-if="!c.appsChunked">
      <div class="app-block" ng-repeat="app in c.data.appList">
        <img src="{{app.image}}" class="app-block-img pull-left gap-right">
        <p>{{app.name}}</p>
      </div>
    </div>
  </div>

  <div class="applist" ng-show="c.showServices">
    <div>
      <ol class="breadcrumb">
        <li><a href="javascript:void(0)" class="appname-breadcrumb" ng-click="c.hideServiceList()">{{c.data.experience_short_handle}}</a></li>
        <li class="applications-breadcrumb">Services</li>
      </ol>
    </div>
    <div class="app-build">
      <span> We are leveraging the following services... </span>
    </div>

    <div class="col-xs-6 app-name" ng-repeat="services in c.chunkedServiceData" ng-if="c.servicesChunked">
      <div class="app-block" ng-repeat="service in services">
        <img src="{{service.image}}" class="app-block-img pull-left gap-right">
        <p ng-if="service.link"><a href="{{service.link}}" target="_blank">{{service.name}}</a></p>
        <p ng-if="!service.link">{{service.name}}</p>
      </div>
    </div>

    <div class="col-xs-12 app-name" ng-if="!c.servicesChunked">
      <div class="app-block" ng-repeat="service in c.data.serviceList">
        <img src="{{service.image}}" class="app-block-img pull-left gap-right">
        <p>{{service.name}}</p>
      </div>
    </div>
  </div>


</div>]]></template>
    </sp_widget>
</record_update>
